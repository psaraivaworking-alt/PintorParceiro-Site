<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pintor Parceiro - Cadastro</title>
    <link rel="icon" href="https://i.postimg.cc/Wz2WcVgm/Selo-Pintor-PArceiro.png" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css"> <!-- Mantenha o link para o CSS externo para o estilo geral -->
    <!-- Para os ícones de olho (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="form-page"> 

    <header>
        <div class="navbar">
            <a href="index.html" class="logo">
                <img src="https://i.postimg.cc/cL0sk9DQ/Marca-Pintor-Parceiro-1.png" alt="Logo Pintor Parceiro" class="logo-img">
            </a>
            <div class="nav-links">
                <!-- Botão de Login no header da página de Cadastro -->
                <a href="login.html" class="btn-primary-header">Login</a>
                <a href="busca.html" class="btn-primary-header">Buscar Pintores</a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="form-card">
            <h2 style="margin-bottom: 3rem;">Cadastre-se</h2>

            <div class="registration-choice">
                <h3>Escolha o tipo de cadastro:</h3>
                <div class="choice-buttons">
                    <button type="button" class="btn-choice active" id="btnPainter">Cadastre-se como Pintor</button>
                    <button type="button" class="btn-choice" id="btnClient">Cadastre-se como Cliente</button>
                </div>
            </div>

            <!-- Formulário de Cadastro de Pintor -->
            <form id="painterRegisterForm" style="display: block;"> <!-- Visível por padrão ao carregar -->
                <h3 class="form-section-title">Dados Pessoais</h3>
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="painterName">Nome Completo</label>
                        <input type="text" id="painterName" name="painterName" required>
                    </div>
                    <div class="form-group cpf-input">
                        <label for="painterCpf">CPF</label>
                        <input type="text" id="painterCpf" name="painterCpf" placeholder="000.000.000-00" required maxlength="14"> 
                    </div>
                </div>

                <h3 class="form-section-title">Dados da Conta</h3>
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="painterPhone">Telefone de Contato</label>
                        <input type="tel" id="painterPhone" name="painterPhone" placeholder="(DD) 00000-0000" required maxlength="15">
                    </div>
                    <div class="form-group">
                        <label for="painterEmail">Email</label>
                        <input type="email" id="painterEmail" name="painterEmail" required>
                    </div>
                </div>
                <div class="form-grid col-2">
                    <div class="form-group password-group">
                        <label for="painterPassword">Senha</label>
                        <input type="password" id="painterPassword" name="painterPassword" required>
                        <span class="password-toggle" id="togglePainterPassword">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    <div class="form-group password-group">
                        <label for="painterConfirmPassword">Confirmação de Senha</label>
                        <input type="password" id="painterConfirmPassword" name="painterConfirmPassword" required>
                        <span class="password-toggle" id="togglePainterConfirmPassword">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                </div>

                <h3 class="form-section-title">Endereço</h3>
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="painterCep">CEP</label>
                        <input type="text" id="painterCep" name="painterCep" placeholder="00000-000" required maxlength="9">
                    </div>
                    <div class="form-group">
                        <label for="painterCity">Cidade</label>
                        <input type="text" id="painterCity" name="painterCity" required readonly> <!-- Campo de cidade será preenchido automaticamente -->
                    </div>
                </div>
                <div class="form-group form-full-width">
                    <label for="painterState">Estado</label>
                    <input type="text" id="painterState" name="painterState" required readonly> <!-- Campo de estado também -->
                </div>
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="painterStreet">Rua</label>
                        <input type="text" id="painterStreet" name="painterStreet" required>
                    </div>
                    <div class="form-group">
                        <label for="painterNumber">Número</label>
                        <input type="text" id="painterNumber" name="painterNumber">
                        <div class="no-number-option">
                            <input type="checkbox" id="painterNoNumber">
                            <label for="painterNoNumber">Sem Número (S/N)</label>
                        </div>
                    </div>
                </div>

                <h3 class="form-section-title">Outras Informações</h3>
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="painterSocialMedia">Rede Social (opcional)</label>
                        <input type="text" id="painterSocialMedia" name="painterSocialMedia" placeholder="URL do perfil">
                    </div>
                    <div class="form-group experience-group">
                        <label>Tempo de Experiência</label>
                        <input type="number" id="painterExperienceValue" name="painterExperienceValue" min="0" value="0" required>
                        <div class="radio-options">
                            <div class="radio-option">
                                <input type="radio" id="expMonths" name="painterExperienceUnit" value="Meses" checked>
                                <label for="expMonths">Meses</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="expYears" name="painterExperienceUnit" value="Anos">
                                <label for="expYears">Anos</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group form-full-width">
                    <label for="painterBio">Biografia (Máx. 200 caracteres)</label>
                    <textarea id="painterBio" name="painterBio" rows="4" maxlength="200" placeholder="Fale um pouco sobre sua experiência, especialidades, etc." required></textarea>
                    <div class="bio-counter" id="painterBioCounter">0/200</div>
                    <div class="profanity-error" id="painterBioProfanityError">Conteúdo inapropriado detectado na biografia.</div>
                </div>

                <button type="submit" class="btn-submit">Cadastrar Pintor</button>
            </form>

            <!-- Formulário de Cadastro de Cliente (Escondido por padrão, será ativado via JS) -->
            <form id="clientRegisterForm" style="display: none;">
                <h3 class="form-section-title">Dados Pessoais</h3>
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="clientName">Nome Completo</label>
                        <input type="text" id="clientName" name="clientName" required>
                    </div>
                    <div class="form-group cpf-input">
                        <label for="clientCpf">CPF</label>
                        <input type="text" id="clientCpf" name="clientCpf" placeholder="000.000.000-00" required maxlength="14">
                    </div>
                </div>

                <h3 class="form-section-title">Dados da Conta</h3>
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="clientPhone">Telefone de Contato</label>
                        <input type="tel" id="clientPhone" name="clientPhone" placeholder="(DD) 00000-0000" required maxlength="15">
                    </div>
                    <div class="form-group">
                        <label for="clientEmail">Email</label>
                        <input type="email" id="clientEmail" name="clientEmail" required>
                    </div>
                </div>
                <div class="form-grid col-2">
                    <div class="form-group password-group">
                        <label for="clientPassword">Senha</label>
                        <input type="password" id="clientPassword" name="clientPassword" required>
                        <span class="password-toggle" id="toggleClientPassword">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                    <div class="form-group password-group">
                        <label for="clientConfirmPassword">Confirmação de Senha</label>
                        <input type="password" id="clientConfirmPassword" name="clientConfirmPassword" required>
                        <span class="password-toggle" id="toggleClientConfirmPassword">
                            <i class="fas fa-eye"></i>
                        </span>
                    </div>
                </div>

                <h3 class="form-section-title">Endereço</h3> <!-- Adicionado para o cliente -->
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="clientCep">CEP</label>
                        <input type="text" id="clientCep" name="clientCep" placeholder="00000-000" required maxlength="9">
                    </div>
                    <div class="form-group">
                        <label for="clientCity">Cidade</label>
                        <input type="text" id="clientCity" name="clientCity" required readonly>
                    </div>
                </div>
                <div class="form-group form-full-width">
                    <label for="clientState">Estado</label>
                    <input type="text" id="clientState" name="clientState" required readonly>
                </div>
                <div class="form-grid col-2">
                    <div class="form-group">
                        <label for="clientStreet">Rua</label>
                        <input type="text" id="clientStreet" name="clientStreet" required>
                    </div>
                    <div class="form-group">
                        <label for="clientNumber">Número</label>
                        <input type="text" id="clientNumber" name="clientNumber">
                        <div class="no-number-option">
                            <input type="checkbox" id="clientNoNumber">
                            <label for="clientNoNumber">Sem Número (S/N)</label>
                        </div>
                    </div>
                </div>
                <!-- Fim dos campos de endereço adicionados para o cliente -->

                <button type="submit" class="btn-submit">Cadastrar Cliente</button>
            </form>
            
            <div class="login-link">
                Já tem cadastro? <a href="login.html">Acessar Perfil</a>
            </div>
            <div id="messageBox" class="message-box"></div> <!-- Adicionado para mensagens de feedback -->
        </div>
    </main>

    <footer>
        <div class="container footer-content">
            <h4>Pintor Parceiro</h4>
            <p>Conectando você aos melhores pintores da sua região</p>
            <p>© 2025 Todos os direitos reservados - Tintas Veloz</p>
        </div>
    </footer>

    <!-- Script JavaScript embutido para as funcionalidades da página -->
    <script type="module">
        // Importar as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // Sua configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCmuGFCKnZ-qBVUpDxs6moJis19lx8nvXw", 
            authDomain: "pintordata.firebaseapp.com",
            projectId: "pintordata",
            storageBucket: "pintordata.firebasestorage.app",
            messagingSenderId: "994883381349",
            appId: "1:994883381349:web:b802e44d49d6f6f163fe8c"
        };

        // Inicializar o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Funções Utilitárias ---

        // Função para exibir mensagens na UI (substituindo o alert)
        function showMessage(msg, isError = false) {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.textContent = msg;
                messageBox.style.display = 'block';
                if (isError) {
                    messageBox.classList.add('error-message');
                    messageBox.classList.remove('success-message'); 
                } else {
                    messageBox.classList.add('success-message'); 
                    messageBox.classList.remove('error-message');
                }
                setTimeout(() => {
                    messageBox.style.display = 'none';
                    messageBox.classList.remove('success-message', 'error-message');
                }, 5000); 
            } else {
                alert(msg);
            }
        }

        // Função para formatar o CPF (000.000.000-00)
        function formatCpfInput(inputElement) {
            inputElement.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, ''); 
                
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }

                if (value.length > 9) {
                    value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
                } else if (value.length > 6) {
                    value = value.replace(/^(\d{3})(\d{3})(\d{3})$/, '$1.$2.$3');
                } else if (value.length > 3) {
                    value = value.replace(/^(\d{3})(\d{3})$/, '$1.$2');
                }
                
                e.target.value = value;
            });
        }

        // Função para formatar o Telefone (DD) 00000-0000 ou (DD) 0000-0000
        function formatPhoneInput(inputElement) {
            inputElement.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, ''); 

                if (value.length > 11) {
                    value = value.substring(0, 11);
                }

                if (value.length > 10) { 
                    value = value.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3');
                } else if (value.length > 6) { 
                    value = value.replace(/^(\d\d)(\d{4})(\d{4}).*/, '($1) $2-$3');
                } else if (value.length > 2) { 
                    value = value.replace(/^(\d*)/, '($1) ');
                } else {
                    value = value.replace(/^(\d*)/, '$1'); 
                }
                
                e.target.value = value;
            });
        }

        // Função para auto-preencher cidade/estado pelo CEP (ViaCEP)
        async function fetchCepData(cepInput, cityInput, stateInput) {
            let cep = cepInput.value.replace(/\D/g, ''); 
            if (cep.length !== 8) {
                cityInput.value = '';
                stateInput.value = '';
                return;
            }

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await response.json();

                if (data.erro) {
                    cityInput.value = 'CEP não encontrado';
                    stateInput.value = '';
                    showMessage('CEP não encontrado. Por favor, verifique.', true);
                } else {
                    cityInput.value = data.localidade;
                    stateInput.value = data.uf;
                }
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                cityInput.value = 'Erro ao buscar CEP';
                stateInput.value = '';
                showMessage('Erro ao buscar CEP. Tente novamente mais tarde.', true);
            }
        }

        // Palavras proibidas para o filtro de profanidade (adaptado para o seu pedido)
        const forbiddenWords = [
            /\bcu\b/, /\bmerda\b/, /\bcaralho\b/, /\bbuceta\b/, /\bputa\b/, /\bfoda\b/, 
            /\bdesgraça\b/, /\binferno\b/, /\bpau\b/, /\brola\b/, /\bsexo\b/, /\bxana\b/
        ];

        function containsProfanity(text) {
            const lowerText = text.toLowerCase();
            if (lowerText.includes('pinto') && !forbiddenWords.some(regex => regex.test(lowerText.replace('pinto', '')))) {
                return false;
            }
            return forbiddenWords.some(regex => regex.test(lowerText));
        }

        // Lógica para alternar a visibilidade da senha (para pintor e cliente)
        document.addEventListener('DOMContentLoaded', () => {
            function setupPasswordToggle(passwordInputId, toggleButtonId) {
                const passwordInput = document.getElementById(passwordInputId);
                const toggleButton = document.getElementById(toggleButtonId);

                if (passwordInput && toggleButton) {
                    toggleButton.addEventListener('click', function () {
                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);
                        this.querySelector('i').classList.toggle('fa-eye');
                        this.querySelector('i').classList.toggle('fa-eye-slash');
                    });
                }
            }

            // Configurar para o formulário de pintor
            setupPasswordToggle('painterPassword', 'togglePainterPassword');
            setupPasswordToggle('painterConfirmPassword', 'togglePainterConfirmPassword');
            
            // Configurar para o formulário de cliente
            setupPasswordToggle('clientPassword', 'toggleClientPassword');
            setupPasswordToggle('clientConfirmPassword', 'toggleClientConfirmPassword');


            // Lógica para alternar entre formulário de Pintor e Cliente
            const btnPainter = document.getElementById('btnPainter');
            const btnClient = document.getElementById('btnClient');
            const painterForm = document.getElementById('painterRegisterForm');
            const clientForm = document.getElementById('clientRegisterForm');

            function showForm(formToShow, formToHide, activeBtn, inactiveBtn) {
                formToShow.style.display = 'block';
                formToHide.style.display = 'none';
                activeBtn.classList.add('active');
                inactiveBtn.classList.remove('active');
            }

            btnPainter.addEventListener('click', () => {
                showForm(painterForm, clientForm, btnPainter, btnClient);
            });

            btnClient.addEventListener('click', () => {
                showForm(clientForm, painterForm, btnClient, btnPainter);
            });

            // Lógica para o contador de caracteres da biografia
            const painterBio = document.getElementById('painterBio');
            const painterBioCounter = document.getElementById('painterBioCounter');
            if (painterBio) {
                painterBio.addEventListener('input', () => {
                    painterBioCounter.textContent = `${painterBio.value.length}/200`;
                });
                painterBioCounter.textContent = `${painterBio.value.length}/200`;
            }

            // Lógica para o checkbox "Sem Número" (Pintor)
            const painterNumberInput = document.getElementById('painterNumber');
            const painterNoNumberCheckbox = document.getElementById('painterNoNumber');

            if (painterNoNumberCheckbox && painterNumberInput) {
                painterNoNumberCheckbox.addEventListener('change', () => {
                    if (painterNoNumberCheckbox.checked) {
                        painterNumberInput.value = 'S/N';
                        painterNumberInput.setAttribute('readonly', 'readonly');
                    } else {
                        painterNumberInput.value = '';
                        painterNumberInput.removeAttribute('readonly');
                    }
                });
            }

            // Lógica para o checkbox "Sem Número" (Cliente)
            const clientNumberInput = document.getElementById('clientNumber');
            const clientNoNumberCheckbox = document.getElementById('clientNoNumber');

            if (clientNoNumberCheckbox && clientNumberInput) {
                clientNoNumberCheckbox.addEventListener('change', () => {
                    if (clientNoNumberCheckbox.checked) {
                        clientNumberInput.value = 'S/N';
                        clientNumberInput.setAttribute('readonly', 'readonly');
                    } else {
                        clientNumberInput.value = '';
                        clientNumberInput.removeAttribute('readonly');
                    }
                });
            }

            // Aplica máscaras de formatação no carregamento da página (Pintor)
            const painterCpfInput = document.getElementById('painterCpf');
            const painterPhoneInput = document.getElementById('painterPhone');
            const painterCepInput = document.getElementById('painterCep');
            const painterCityInput = document.getElementById('painterCity');
            const painterStateInput = document.getElementById('painterState');


            if (painterCpfInput) formatCpfInput(painterCpfInput);
            if (painterPhoneInput) formatPhoneInput(painterPhoneInput);
            if (painterCepInput && painterCityInput && painterStateInput) {
                painterCepInput.addEventListener('blur', () => fetchCepData(painterCepInput, painterCityInput, painterStateInput));
                painterCepInput.addEventListener('input', () => {
                    if (painterCepInput.value.replace(/\D/g, '').length !== 8) {
                        painterCityInput.value = '';
                        painterStateInput.value = '';
                    }
                });
            }

            // Aplica máscaras de formatação no carregamento da página (Cliente)
            const clientCpfInput = document.getElementById('clientCpf');
            const clientPhoneInput = document.getElementById('clientPhone');
            const clientCepInput = document.getElementById('clientCep');
            const clientCityInput = document.getElementById('clientCity');
            const clientStateInput = document.getElementById('clientState');

            if (clientCpfInput) formatCpfInput(clientCpfInput);
            if (clientPhoneInput) formatPhoneInput(clientPhoneInput);
            if (clientCepInput && clientCityInput && clientStateInput) {
                clientCepInput.addEventListener('blur', () => fetchCepData(clientCepInput, clientCityInput, clientStateInput));
                clientCepInput.addEventListener('input', () => {
                    if (clientCepInput.value.replace(/\D/g, '').length !== 8) {
                        clientCityInput.value = '';
                        clientStateInput.value = '';
                    }
                });
            }
        });

        // --- Lógica de submissão de formulários (Pintor e Cliente) ---
        const painterRegisterForm = document.getElementById('painterRegisterForm');
        const clientRegisterForm = document.getElementById('clientRegisterForm');

        if (painterRegisterForm) {
            painterRegisterForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('painterName').value;
                const email = document.getElementById('painterEmail').value;
                const password = document.getElementById('painterPassword').value;
                const confirmPassword = document.getElementById('painterConfirmPassword').value;
                const cpf = document.getElementById('painterCpf').value.replace(/\D/g, '');
                const phone = document.getElementById('painterPhone').value.replace(/\D/g, '');
                const cep = document.getElementById('painterCep').value.replace(/\D/g, '');
                const city = document.getElementById('painterCity').value;
                const state = document.getElementById('painterState').value;
                const street = document.getElementById('painterStreet').value;
                const number = document.getElementById('painterNumber').value;
                const socialMedia = document.getElementById('painterSocialMedia').value;
                const experienceValue = document.getElementById('painterExperienceValue').value;
                const experienceUnit = document.querySelector('input[name="painterExperienceUnit"]:checked').value;
                const bio = document.getElementById('painterBio').value;

                // Validações
                if (password !== confirmPassword) {
                    showMessage("As senhas não coincidem.", true);
                    return;
                }
                if (cpf.length !== 11) {
                    showMessage("CPF inválido. Por favor, digite 11 dígitos.", true);
                    return;
                }
                if (phone.length < 10 || phone.length > 11) { 
                    showMessage("Telefone inválido. Verifique o DDD e o número.", true);
                    return;
                }
                if (city === '' || state === '' || city === 'CEP não encontrado' || city === 'Erro ao buscar CEP') {
                    showMessage("CEP inválido ou não preenchido. Por favor, verifique.", true);
                    return;
                }
                if (containsProfanity(bio)) {
                    showMessage("Biografia contém palavras inapropriadas. Por favor, revise.", true);
                    return;
                }

                try {
                    const qCpf = query(collection(db, "pintores"), where("cpf", "==", cpf));
                    const querySnapshotCpf = await getDocs(qCpf);
                    if (!querySnapshotCpf.empty) {
                        showMessage("Este CPF já está cadastrado como pintor.", true);
                        return;
                    }
                    
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    await setDoc(doc(db, "pintores", user.uid), {
                        tipo: 'pintor', 
                        nome: name,
                        email: email,
                        cpf: cpf,
                        telefone: phone,
                        cep: cep,
                        cidade: city,
                        estado: state,
                        rua: street,
                        numero: number,
                        redeSocial: socialMedia,
                        experiencia: `${experienceValue} ${experienceUnit}`, 
                        biografia: bio,
                        dataCadastro: new Date(),
                    });

                    showMessage("Cadastro de pintor realizado com sucesso! Redirecionando para o login...", false);
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);

                } catch (error) {
                    const errorCode = error.code;
                    const errorMessage = error.message;

                    if (errorCode === 'auth/email-already-in-use') {
                        showMessage("O email fornecido já está em uso por outra conta.", true);
                    } else if (errorCode === 'auth/weak-password') {
                        showMessage("A senha é muito fraca. Ela deve ter pelo menos 6 caracteres.", true);
                    } else {
                        showMessage("Erro no cadastro de pintor: " + errorMessage, true);
                    }
                    console.error(error);
                }
            });
        }

        if (clientRegisterForm) {
            clientRegisterForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const name = document.getElementById('clientName').value;
                const email = document.getElementById('clientEmail').value;
                const password = document.getElementById('clientPassword').value;
                const confirmPassword = document.getElementById('clientConfirmPassword').value;
                const cpf = document.getElementById('clientCpf').value.replace(/\D/g, '');
                const phone = document.getElementById('clientPhone').value.replace(/\D/g, '');
                const cep = document.getElementById('clientCep').value.replace(/\D/g, ''); // Novo campo
                const city = document.getElementById('clientCity').value;       // Novo campo
                const state = document.getElementById('clientState').value;     // Novo campo
                const street = document.getElementById('clientStreet').value;   // Novo campo
                const number = document.getElementById('clientNumber').value;   // Novo campo

                // Validações
                if (password !== confirmPassword) {
                    showMessage("As senhas não coincidem.", true);
                    return;
                }
                if (cpf.length !== 11) {
                    showMessage("CPF inválido. Por favor, digite 11 dígitos.", true);
                    return;
                }
                if (phone.length < 10 || phone.length > 11) { 
                    showMessage("Telefone inválido. Verifique o DDD e o número.", true);
                    return;
                }
                if (cep.length !== 8 || city === '' || state === '' || city === 'CEP não encontrado' || city === 'Erro ao buscar CEP') {
                    showMessage("CEP inválido ou não preenchido. Por favor, verifique.", true);
                    return;
                }


                try {
                    const qCpf = query(collection(db, "usuarios"), where("cpf", "==", cpf));
                    const querySnapshotCpf = await getDocs(qCpf);
                    if (!querySnapshotCpf.empty) {
                        showMessage("Este CPF já está cadastrado como cliente.", true);
                        return;
                    }

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    await setDoc(doc(db, "usuarios", user.uid), {
                        tipo: 'cliente', 
                        nome: name,
                        email: email,
                        cpf: cpf,
                        telefone: phone,
                        cep: cep,        // Adicionado
                        cidade: city,    // Adicionado
                        estado: state,   // Adicionado
                        rua: street,     // Adicionado
                        numero: number,  // Adicionado
                        dataCadastro: new Date(),
                    });

                    showMessage("Cadastro de cliente realizado com sucesso! Redirecionando para o login...", false);
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);

                } catch (error) {
                    const errorCode = error.code;
                    const errorMessage = error.message;

                    if (errorCode === 'auth/email-already-in-use') {
                        showMessage("O email fornecido já está em uso por outra conta.", true);
                    } else if (errorCode === 'auth/weak-password') {
                        showMessage("A senha é muito fraca. Ela deve ter pelo menos 6 caracteres.", true);
                    } else {
                        showMessage("Erro no cadastro de cliente: " + errorMessage, true);
                    }
                    console.error(error);
                }
            });
        }
    </script>
</body>
</html>
